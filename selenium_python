from selenium import webdriver
# web driver wait
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
# date
import datetime

# excel
from openpyxl import load_workbook

# path
chromeDriverPath: str = "C:\\Users\\Muthe Udaya Sankar\\PycharmProjects\\carDealerz\\Drivers\\chromedriver.exe"
excelPath: str = "C:\\Users\\Muthe Udaya Sankar\\Desktop\\carDealerz.xlsx"

karanLocal = datetime.datetime.today()
previousDay = datetime.datetime.today() - datetime.timedelta(days=1)

# excel workbook setup
workbook = load_workbook(excelPath)
sheet = workbook.active
element_arr = []
list_arr = []

browser = webdriver.Chrome(executable_path=chromeDriverPath)

browser.get("https://cardealerz.mu/offres")

# check if page is in french
lang = browser.find_element_by_xpath("/html/body/div[2]/div/div[2]/div[2]/span")
print("Language: " + lang.text)
if lang.text != "FR":
    print("Language not french. Stopping!")
    exit()

# wait for container
page = WebDriverWait(browser, 10).until(EC.presence_of_element_located((By.CLASS_NAME, 'list-container')))
# page = browser.find_element_by_class_name("list-container")
# search for elements' tag name
articles = page.find_elements_by_tag_name("li")

# loop in each element
for article in articles:
    try:
        # skip advert
        article.find_element_by_class_name("pba-list")
        print("ad found")
        continue
    except:

        try:
            # description
            desc = article.find_element_by_class_name("an-titre")
            # date
            date = article.find_element_by_class_name("an-date")
            date_str = date.text
            if("Aujourd'hui" in date_str):
                date_str = karanLocal.date()
            elif("Hier" in date_str):
                date_str = previousDay.date()
            # price
            price = article.find_element_by_class_name("an-prix")
            # category
            cat = article.find_element_by_class_name("an-cat")
            # location
            loc = article.find_element_by_class_name("an-lieu")
            # link
            link = article.find_element_by_tag_name("a").get_attribute("href")

            element_arr = [date_str, desc.text, cat.text, loc.text, price.text, link]
            # print(element_arr)
            sheet.append(element_arr)
        except Exception as e:
            print("Error while reading->")
            print(e)

workbook.save(excelPath)
browser.quit()
