<?xml version="1.0" encoding="UTF-8"?>
<config xmlns="http://web-harvest.sourceforge.net/schema/1.0/config" scriptlang="groovy">

<var-def name="ph">
		<datastore name="public_holidays">
			SELECT * from @this
		</datastore>
</var-def>
	
	<robotics-flow>
<robot driver="universal" name="driver" start-in-private="false" close-on-completion="true">
			<capability name ="SEARCH_ALL_WINDOWS" value="true"/>
			<capability name="CLOSE_ALL_WINDOWS" value="false"/>
		<script><![CDATA[
		
			//robot checks for records for previous working day-->e.g FRI 24/07 robot puts criteria 23 12:00 AM and 24 12:00 AM, checks for IBK then compare with MA Files for 23
			
			//listings is also appending into hashmap->added listing condition before appeding to hashmap 07/08/20
			//date scenarios for morongwa query -- monday, public holiday, pwd falls on pevious month(previous working month) 11/08/20
			//getting issue while downloading morongwa excel -->button to be clicked might be disabled-->dynamic wait 12/08/20
			//account not matching if contains all numbers sometimes -- removed leading 0s 12/08/20 
			//search in MA Files 13/08/20
			
			//add missing scenarios for account number
			//delete morongwa excel after use or move to daily folder	
			//auth login
			
			//matched hashmap that containts search reference and amount if matched
			//search in 201 folder if not found in MA
			
			
			//date
			import java.time.LocalDate;
			import java.time.LocalDateTime;
			import java.time.ZoneId;
			import java.time.format.DateTimeFormatter
						
			//apache excel
			import org.apache.poi.xssf.usermodel.*;
			import org.apache.poi.ss.usermodel.*;
			import org.apache.poi.hssf.usermodel.*;
			import java.text.SimpleDateFormat;
			import org.apache.poi.ss.usermodel.DateUtil;
			
			//java string manipulation
			import java.text.DecimalFormat;
			import java.math.*; //big decimal
			
			//DATE
			LocalDate karanLocal    = LocalDate.parse("2020-07-24"); 							
			//LocalDate karanLocal    = LocalDate.now()		
			LocalDate pwd		    = karanLocal.minusDays(1);										//live
			DateTimeFormatter csvDateFormat   = DateTimeFormatter.ofPattern("M/d/yyyy");

			DateTimeFormatter morongwaQueryDateFormat   = DateTimeFormatter.ofPattern("d");
			DateTimeFormatter MAFileDateFormat			= DateTimeFormatter.ofPattern("MMdd");
			
			//PORTAL
			String morongwa_uat = "https://celine-morongwa-uat.apps.nonprod.ocp.absa.co.za/#/";
			String morongwa_live = "https://morongwa.prod.ocp.absa.co.za/#/";
			String morongwa_login = "ABOR048";
			String morongwa_pass = "Finger9.Ever";
			
			//PATH
			String download_path = "C:\\Users\\RB-MU_Robot_VPC_01\\Downloads\\";
			String morongwa_path = "";
			String MAFolder_path = "Q:\\CORPORATE ENTITY\\Year 2020\\Sybrin Echannel\\";
			
			//swift cmp
			String[] bombaclak;
			ArrayList bombaclakos = new ArrayList();
			ArrayList<Double> swiftAmountArr = new ArrayList<Double>();
			ArrayList<String> swiftSearchRefArr = new ArrayList<String>();
			HashMap<String,Double> compared = new HashMap<String,Double>;
			
			Double swiftAmount = 0.0;
			String swiftBOName = "";
			String swiftAccNum = "";
			boolean listing = false;
			
			
			//LIST OF PUB_HO
			List dateList = new ArrayList();
			for(int i = 0; i < ph.size(); i++){
				date = ph.get(i).getAt("Date").toString();	
				dateList.add(date);
			}
			
			//PREVIOUS WORKING DAY
			boolean validPwd = false;
			while(!validPwd){
				
				String pwdCheck = pwd.format(csvDateFormat);
					 
				//PREVIOUS WORKING IS A NON-SUNDAY PUBLIC HOLIDAY
				if(dateList.contains(pwdCheck) && pwd.getDayOfWeek().toString() != "SUNDAY"){
					pwd = pwd.minusDays(1);

				}
				//THE WEEKND
				else if(pwd.getDayOfWeek().toString() == "SUNDAY"){
					//SUNDAY
					if(pwd.getDayOfWeek().toString() == "SUNDAY"){
						pwd = pwd.minusDays(1);
					}
					
					//SATURDAY
					if(pwd.getDayOfWeek().toString() == "SATURDAY"){
						pwd = pwd.minusDays(1);
					}
				}
				//ALL OTHER SCENARIOS(NORMAL WORKING DAY)
				else{
					validPwd = true;
				}
				
				
			}

			log.info("Current Day: "+karanLocal);
			//PWD CHANGES 
			log.info("Previous Working Day: "+pwd);
			
			 
			//////////////////////////////////////////////////////////DOWNLOAD MORONGWA/////////////////////////////////////////////////////////////////
			
			
			//LOGIN
			openChrome(morongwa_live);
			$(byXpath('//*[@id="username"]')).sendKeys(morongwa_login);
			$(byXpath('//*[@id="password"]')).sendKeys(morongwa_pass);
			$(byXpath('//*[@id="kc-login"]')).click();
			
			//G_AUTH 
			
			//test
			//switchToExistingWindow(new WindowDescriptor("", "(?i).*\\QMorongwa\\E.*", false, true).toString(), 1000)
			
			//Morongwa ARO
			$(byXpath('//*[@id="morongwa-aro"]')).click();
			sleep(5000);
			
			//MESSAGES
			
			//SYSTEM DATE--from--if pwd is friday or public holiday
			String morongwaPwDate = pwd.format(morongwaQueryDateFormat);
			if(pwd != karanLocal.minusDays(1)){
				//change month
				$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[1]/div/div[4]/div[1]/angular2-date-picker/div/div[1]')).click();
				if(pwd.getMonth() != karanLocal.getMonth()){
					$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[1]/div/div[4]/div[1]/angular2-date-picker/div/div[2]/div[2]/i[1]')).click();
				}
				$(byText(morongwaPwDate)).click();
				//$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[1]/div/div[4]/div[1]/angular2-date-picker/div/div[1]')).click();
				//$(byAttribute('class','wc-date-container')).click();
			}
			
			//SYSTEM DATE--to
			//choose system date
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[2]/div/div[2]/select')).click(); 
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[2]/div/div[2]/select/option[20]')).click(); 
			sleep(1000);
			//choose operator
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[2]/div/div[3]/select')).click();
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[2]/div/div[3]/select/option[3]')).click();
			sleep(1000);
			//choose date/time
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[2]/div/div[4]/div[1]/angular2-date-picker/div/div[1]')).click();
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[2]/div/div[4]/div[1]/angular2-date-picker/div/div[2]/div[1]/div[4]/div/span')).click();
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[2]/div/div[4]/div[1]/angular2-date-picker/div/div[2]/div[5]/div[1]/div[1]/input')).text("12");
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[2]/div/div[4]/div[1]/angular2-date-picker/div/div[2]/div[5]/div[1]/div[3]/input')).text("00");
			sleep(1000);
			//am
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[2]/div/div[4]/div[1]/angular2-date-picker/div/div[2]/div[5]/div[2]/div/button[1]')).click();
			sleep(1000);
			//pm
			//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[2]/div/div[4]/div[1]/angular2-date-picker/div/div[2]/div[5]/div[2]/div/button[2]
			sendKeys(Keys.PAGE_DOWN);
			sleep(1000);
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[2]/div/div[4]/div[1]/angular2-date-picker/div/div[2]/div[5]/div[3]')).click();
			sleep(1000);
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[2]/div/div[4]/div[1]/angular2-date-picker/div/div[2]/div[6]/div')).click();
			
			//ADD QUERY
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/div[2]/label')).click();
			
			//DIRECTION
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[3]/div/div[2]/select')).click();
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[3]/div/div[2]/select/option[8]')).click();
			$(byXpath('//*[@id="direction"]')).click();
			$(byXpath('//*[@id="direction"]/option[2]')).click();
			
			//ADD QUERY
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/div[2]/label')).click();
			
			//MESSAGE TYPE
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[4]/div/div[2]/select')).click();
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[4]/div/div[2]/select/option[10]')).click();
			$(byXpath('//*[@id="messageType"]')).text("MT202");
			
			//ADD QUERY
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/div[2]/label')).click();
			
			//CURRENCY CODE
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[5]/div/div[2]/select')).click();
			$(byXpath('//*[@id="queryTab-panel"]/form/div/div/mor-query-builder/ul/li[5]/div/div[2]/select/option[6]')).click();
			$(byXpath('//*[@id="paymentDetails_currencyCode"]')).text('MUR');
			
			//test
			sleep(20000)
			
			//SEARCH
			sleep(2000);
			//$(byXpath('//*[@id="queryTab-panel"]/form/div/div/div/label/')).click();
			$(byText('Search')).click();
			
			
			//DOWNLOAD EXCEL
			boolean download = $(byXpath('/html/body/app-root/div/div/div/ng-component/div[1]/ng-component/div/div[2]/div/div/div[1]/div/mor-data-export/div/button')).is(ENABLED);
			while(!download){
				download = $(byXpath('/html/body/app-root/div/div/div/ng-component/div[1]/ng-component/div/div[2]/div/div/div[1]/div/mor-data-export/div/button')).is(ENABLED);
				sleep(2500);
			}

			if(download){ 
				$(byXpath('/html/body/app-root/div/div/div/ng-component/div[1]/ng-component/div/div[2]/div/div/div[1]/div/mor-data-export/div/button')).click();
				$(byXpath('/html/body/app-root/div/div/div/ng-component/div[1]/ng-component/div/div[2]/div/div/div[1]/div/mor-data-export/div/div/button[1]')).click();
				sleep(5000);
			}
			File downloadFolder = new File(download_path);
			File[] downloadFiles = downloadFolder.listFiles();
			for(File file : downloadFiles){
				if(file.getName().contains("Morongwa_export")){
					morongwa_path = file.toPath();
				}
			}
		 	//////////////////////////////////////////////////////////DOWNLOAD MORONGWA/////////////////////////////////////////////////////////////////
			File morongwaFile = new File(morongwa_path);	
			//////////////////////////////////////////////////////////READ SWIFT MESSAGE//////////////////////////////////////////////////////////////////
		
			FileInputStream fisi1 = new FileInputStream(morongwaFile);
			XSSFWorkbook outputWorkbook1 = new XSSFWorkbook(fisi1);
			XSSFSheet outputSheet1 = outputWorkbook1.getSheetAt(0);	
			
			int outputRowCount1 = outputSheet1.getLastRowNum();
			int currentRowIndex1=1;//CHANGE
			
			Iterator rowIterator1 = outputSheet1.iterator();
			
			xlsRecord: while(rowIterator1.hasNext()){
			
				//reinitialise arrays and variables
				bombaclak = new String[0];
				swiftAccNum = "";
				swiftBOName = "";
				swiftAmount = 0.0;
				listing = false;
				
				Row currentRow1 = outputSheet1.getRow(currentRowIndex1);
				if(currentRow1 == null){
					break;
				}
			
				Cell cellData1 = currentRow1.getCell(18,Row.MissingCellPolicy.RETURN_BLANK_AS_NULL); //column 18 "Fin Format"
				DataFormatter formatter1 = new DataFormatter();
				value1 = formatter1.formatCellValue(cellData1);
				
				if(value1.contains("IBK")){
					//println("----------------------------")
					
					//sleep(5000)
					//println("eyebeeks foundos")
					//println("IBK->"+currentRowIndex1);
					
					//delimiters(remove start and end of swift message tag)
					int startIndex = value1.indexOf(":20")
					int endIndex = value1.indexOf("-}");
					value1 = value1.substring(startIndex+1,endIndex-1);
					bombaclak = value1.split(":");
					
					
					//SEARCH FOR AMOUNT 
					for(int i = 0; i < bombaclak.size(); i++){
						
						if(bombaclak[i].contains("MUR") && bombaclak[i-1].contains("32A")){
							int amountIndex = bombaclak[i].indexOf("R");
							String amountStr = bombaclak[i].substring(amountIndex+1, bombaclak[i].length());
							amountStr = amountStr.replace(",",".");
							swiftAmount = Double.parseDouble(amountStr);
							//println(swiftAmount);
							
						}
						
					}
					
					//SEARCH FOR ACCOUNT DETAILS
					String accountDetailsRaw = bombaclak[bombaclak.size()-1].trim();
					accountDetailsRaw = accountDetailsRaw.replace("//","");
					String[] accountDetailsRawArr = accountDetailsRaw.split("\\r?\\n");
					for(int i = 0; i < accountDetailsRawArr.size(); i++){
						
						//LISTING TO FOLLOW(will receive transactions by mail->skip)
						if(accountDetailsRawArr[i].contains("LISTINGS")){
							//continue xlsRecord;
							listing = true;
							break;
						}
						
						
						//by order of(name of person..)
						if(accountDetailsRawArr[i].contains("BO") || accountDetailsRawArr[i].contains("B/O") ){

							int nameIndex = accountDetailsRawArr[i].indexOf("O");
							String name = accountDetailsRawArr[i]
							name = name.substring(nameIndex+1, name.length());
							swiftBOName = name.trim();
							//println(swiftBOName)
							
						}
						
						//ACCOUNT NUMBER
						//invalid credit account number
						if(accountDetailsRawArr[i].contains("INVALID CREDIT ACCOUNT")){
							
							int partOneIndex = accountDetailsRawArr[i].indexOf("-");
							String partOne = accountDetailsRawArr[i].substring(partOneIndex+1,accountDetailsRawArr[i].length());
							partOne = partOne.trim();
							String partTwo = accountDetailsRawArr[i+1].trim();
							swiftAccNum = partOne + partTwo;
							//println(swiftAccNum);
							
						}
						//credit account is closed
						if(accountDetailsRawArr[i].contains("CREDIT ACCOUNT IS CLOSED")){
							
							int partOneIndex = accountDetailsRawArr[i].indexOf("-");
							String partOne = accountDetailsRawArr[i].substring(partOneIndex+1,accountDetailsRawArr[i].length());
							partOne = partOne.trim();
							String partTwo = accountDetailsRawArr[i+1].trim();
							swiftAccNum = partOne + partTwo;
							//println(swiftAccNum)
							
						}
						//ac no. is invalid
						if(accountDetailsRawArr[i].contains("AC NO.")){
							
							int partOneIndex = accountDetailsRawArr[i].indexOf(".");
							String partOne = accountDetailsRawArr[i].substring(partOneIndex+1,accountDetailsRawArr[i].length());
							partOne = partOne.trim();
							swiftAccNum = partOne;
							//println(swiftAccNum)
							
						}
						//acc not found
						if(accountDetailsRawArr[i].contains("ACC") && accountDetailsRawArr[i].contains("NOT FOUND")){
							
							int partOneIndex = accountDetailsRawArr[i].indexOf("ACC");
							int partTwoIndex = accountDetailsRawArr[i].indexOf("NO");
							String partOne 	 = accountDetailsRawArr[i].substring(partOneIndex+3,partTwoIndex-1);
							partOne = partOne.trim();
							swiftAccNum = partOne;
							//println(swiftAccNum)
							
						}
						
					}
					//add account details in hashmap
					if(!listing){
						if(swiftAccNum != ""){
							swiftAmountArr.add(swiftAmount);
							swiftSearchRefArr.add(swiftAccNum)
							//println("HASHMAP->"+currentRowIndex1);
						}
						else if(swiftAccNum.isEmpty()){
							swiftAmountArr.add(swiftAmount);
							swiftSearchRefArr.add(swiftBOName);
							//println("HASHMAP->"+currentRowIndex1);
						}
						else if(swiftBOName.isEmpty()){
							swiftAmountArr.add(swiftAmount);
							swiftSearchRefArr.add(" ");
							//println("HASHMAP->"+currentRowIndex1);
						}
					}
					
				}
				
				currentRowIndex1++;
			}
			println(swiftSearchRefArr);
			println(swiftSearchRefArr.size())
			println(swiftAmountArr)
			//////////////////////////////////////////////////////////READ SWIFT MESSAGE//////////////////////////////////////////////////////////////////
			 
			///////////////////////////////////////////////////////////READ MA MESSAGE////////////////////////////////////////////////////////////////////
			String MAFileDatePart = pwd.format(MAFileDateFormat);
			/*String MAFile1 = MA060723-1
			File MAFile = new File("Q:\\CORPORATE ENTITY\\Year 2020\\Sybrin Echannel\\MA060723-1.IBK");
			if(MAFile.exists()){
				Scanner myReader = new Scanner(MAFile);
				myReader.nextLine();  //header
				while(myReader.hasNextLine() && myReader != null){
					
					String raw_status = myReader.nextLine(); 
					String account_num_trimmed = "";
					//check if record matches with account details of swift ibk-for each record 
					for(int i = 0; i < swiftSearchRefArr.size(); i++){
						swiftSearchRefTrimmed = swiftSearchRefArr[i].replaceFirst("^0+(?!$)", "");
						if(raw_status.contains(swiftSearchRefTrimmed)){ //missing screnario-> where there is no acc number or name in swift, then there will be a blank space 
							
							//parse amount and currency
							int lastBlankIndex = raw_status.lastIndexOf(" "); 
							String amount_currency = raw_status.substring(lastBlankIndex+1,raw_status.length());
							String amount_raw = amount_currency.substring(3,amount_currency.length()); //need to test more length of currency
							if(amount_currency.contains("MUR")){
								amount_bd = new BigDecimal(amount_raw);
								amount_bd = amount_bd.movePointLeft(2);
								double amount = amount_bd.doubleValue();
								if(swiftAmountArr[i] == amount){
									println("suxxessa")
								}
							}
						}
					}
				}
					
			}
			*/
			File MAFolder = new File(MAFolder_path);
			File[] MAFiles = MAFolder.listFiles();
			for(File file : MAFiles){
				if(file.getName().contains("MA06"+MAFileDatePart)){
					Scanner myReader = new Scanner(file);
					myReader.nextLine();  //header
					while(myReader.hasNextLine() && myReader != null){
						
						String raw_status = myReader.nextLine(); 
						String account_num_trimmed = "";
						//check if record matches with account details of swift ibk-for each record 
						for(int i = 0; i < swiftSearchRefArr.size(); i++){
							swiftSearchRefTrimmed = swiftSearchRefArr[i].replaceFirst('^0+(?!$)', "");
							if(raw_status.contains(swiftSearchRefTrimmed)){ //missing screnario-> where there is no acc number or name in swift, then there will be a blank space 
								
								//parse amount and currency
								int lastBlankIndex = raw_status.lastIndexOf(" "); 
								String amount_currency = raw_status.substring(lastBlankIndex+1,raw_status.length());
								String amount_raw = amount_currency.substring(3,amount_currency.length()); //need to test more length of currency
								if(amount_currency.contains("MUR")){
									amount_bd = new BigDecimal(amount_raw);
									amount_bd = amount_bd.movePointLeft(2);
									double amount = amount_bd.doubleValue();
									if(swiftAmountArr[i] == amount){
										println("suxxessa")
										compared.put(swiftSearchRefArr[i],swiftAmountArr[i]);
									}
								}
							}
						}
					}
				}
			}
			//if records not found in MA Files, search in .201 files
			if(swiftSearchRefArr[i].size() != compared.size()){
				
			}
			
			
			///////////////////////////////////////////////////////////READ MA MESSAGE////////////////////////////////////////////////////////////////////
			 
			
			]]></script>
	
	</robot>
</robotics-flow>
	
    <export include-original-data="true"></export>

</config>
